<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draw Something Amazing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .canvas-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        padding: 25px;
        max-width: 900px;
        width: 100%;
        position: relative;
        overflow: hidden;
      }

      .canvas-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          #ff6b6b,
          #4ecdc4,
          #45b7d1,
          #96ceb4,
          #ffeaa7,
          #fd79a8
        );
        border-radius: 20px 20px 0 0;
      }

      .header {
        text-align: center;
        margin-bottom: 25px;
      }

      .title {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
      }

      .subtitle {
        color: #666;
        font-size: 1.1rem;
        font-weight: 400;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .brush-btn {
        padding: 12px 20px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .brush-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .brush-btn.active {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }

      .brush-btn.marker {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
      }

      .brush-btn.crayon {
        background: linear-gradient(
          135deg,
          rgb(135, 206, 250),
          rgb(135, 206, 250)
        );
        color: white;
      }

      .brush-btn.wiggle {
        background: linear-gradient(135deg, #ff7675, #fd79a8);
        color: white;
      }

      .brush-btn.spray {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white;
      }

      .brush-btn.fountain {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
      }

      .color-palette-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .palette-title {
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
      }

      .main-colors {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .color-dropdown {
        position: relative;
        display: inline-block;
      }

      .main-color-swatch {
        width: 55px;
        height: 55px;
        border-radius: 12px;
        cursor: pointer;
        border: 4px solid white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .main-color-swatch:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .main-color-swatch.selected {
        border-color: #333;
        box-shadow: 0 0 0 2px white, 0 0 0 6px #333,
          0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .main-color-swatch::after {
        content: "‚ñº";
        position: absolute;
        bottom: -8px;
        right: -8px;
        background: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #666;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
      }

      .main-color-swatch:hover::after {
        transform: scale(1.1);
      }

      .dropdown-content {
        position: absolute;
        top: 75px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        padding: 15px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        min-width: 200px;
      }

      .dropdown-content.show {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        transform: translateX(-50%) translateY(5px);
      }

      .dropdown-content::before {
        content: "";
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid white;
      }

      .palette-group {
        margin-bottom: 15px;
      }

      .palette-group:last-child {
        margin-bottom: 0;
      }

      .palette-name {
        font-size: 0.8rem;
        font-weight: 600;
        color: #666;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .palette-colors {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 6px;
      }

      .palette-color {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }

      .palette-color:hover {
        transform: scale(1.15);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

              .color-labels {
          display: flex;
          justify-content: center;
         gap: 15px;
         margin-top: 10px;
         font-size: 0.8rem;
         color: #666;
         font-weight: 500;
         flex-wrap: wrap;
        }

      .canvas-wrapper {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        background: #fbf8f3;
        position: relative;
      }

      .canvas-wrapper::before {
        content: "‚ú® Click and drag to start drawing! ‚ú®";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #bbb;
        font-size: 1.2rem;
        font-weight: 500;
        pointer-events: none;
        z-index: 1;
        transition: opacity 0.3s ease;
      }

      .canvas-wrapper.drawing::before {
        opacity: 0;
      }

      .canvas-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-bottom: 15px;
      }

      .clear-btn,
      .save-btn,
      .extract-btn {
        border: none;
        border-radius: 20px;
        padding: 8px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        color: white;
      }

      .clear-btn {
        background: #ff6b6b;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .clear-btn:hover {
        background: #ff5252;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .save-btn {
        background: #00b894;
        box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
      }

      .save-btn:hover {
        background: #00a085;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
      }

      .extract-btn {
        background: #4834d4;
        box-shadow: 0 4px 15px rgba(72, 52, 212, 0.3);
      }

      .extract-btn:hover {
        background: #3c2db0;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(72, 52, 212, 0.4);
      }

      .instructions {
        text-align: center;
        margin-top: 20px;
        color: #666;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .title {
          font-size: 2rem;
        }

        .controls {
          gap: 10px;
        }

        .brush-btn {
          padding: 10px 16px;
          font-size: 0.8rem;
        }

                  .color-labels {
           gap: 10px;
           flex-wrap: wrap;
          }

        .main-colors {
          gap: 10px;
        }

        .main-color-swatch {
          width: 50px;
          height: 50px;
        }
      }
    </style>
  </head>
  <body>
    <div class="canvas-container">
      <div class="header">
        <h1 class="title">Draw Something Amazing</h1>
        <p class="subtitle">Express yourself with our magical brushes</p>
      </div>

      <div class="controls">
        <button class="brush-btn marker active" onclick="setBrush('marker')">
          üñçÔ∏è Marker
        </button>
        <button class="brush-btn crayon" onclick="setBrush('crayon')">
          üé® Crayon
        </button>
        <button class="brush-btn wiggle" onclick="setBrush('wiggle')">
          „Ä∞Ô∏è Wiggle
        </button>
        <button class="brush-btn spray" onclick="setBrush('spray')">
          üé® Spray
        </button>
        <button class="brush-btn fountain" onclick="setBrush('fountain')">
          üñãÔ∏è Fountain
        </button>
      </div>

      <div class="color-palette-section">
        <div class="palette-title">üé® Choose Your Color</div>
        <div class="main-colors">
          <!-- Keppel -->
          <div class="color-dropdown">
            <div
              class="main-color-swatch selected"
              id="color1"
              style="background-color: #6bb9a4"
              onclick="selectMainColor('#6BB9A4', 'color1')"
            ></div>
            <div class="dropdown-content" id="dropdown1">
              <div class="palette-group">
                <div class="palette-name">Keppel Light</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #e1f1ed"
                    onclick="selectColor('#E1F1ED', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #c3e3db"
                    onclick="selectColor('#C3E3DB', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #a6d5c8"
                    onclick="selectColor('#A6D5C8', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #88c7b6"
                    onclick="selectColor('#88C7B6', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #6bb9a4"
                    onclick="selectColor('#6BB9A4', 'color1')"
                  ></div>
                </div>
              </div>
              <div class="palette-group">
                <div class="palette-name">Keppel Dark</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #4a9e88"
                    onclick="selectColor('#4A9E88', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #387766"
                    onclick="selectColor('#387766', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #254f44"
                    onclick="selectColor('#254F44', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #132822"
                    onclick="selectColor('#132822', 'color1')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #000"
                    onclick="selectColor('#000000', 'color1')"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sky Blue -->
          <div class="color-dropdown">
            <div
              class="main-color-swatch"
              id="color2"
              style="background-color: #7fc9e1"
              onclick="selectMainColor('#7FC9E1', 'color2')"
            ></div>
            <div class="dropdown-content" id="dropdown2">
              <div class="palette-group">
                <div class="palette-name">Sky Blue Light</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #e5f4f9"
                    onclick="selectColor('#E5F4F9', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #cce9f3"
                    onclick="selectColor('#CCE9F3', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #b2deed"
                    onclick="selectColor('#B2DEED', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #99d3e7"
                    onclick="selectColor('#99D3E7', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #7fc9e1"
                    onclick="selectColor('#7FC9E1', 'color2')"
                  ></div>
                </div>
              </div>
              <div class="palette-group">
                <div class="palette-name">Sky Blue Dark</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #46b0d4"
                    onclick="selectColor('#46B0D4', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #288aab"
                    onclick="selectColor('#288AAB', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #1b5c72"
                    onclick="selectColor('#1B5C72', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #0d2e39"
                    onclick="selectColor('#0D2E39', 'color2')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #000"
                    onclick="selectColor('#000000', 'color2')"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tea Rose -->
          <div class="color-dropdown">
            <div
              class="main-color-swatch"
              id="color3"
              style="background-color: #ffd1d1"
              onclick="selectMainColor('#FFD1D1', 'color3')"
            ></div>
            <div class="dropdown-content" id="dropdown3">
              <div class="palette-group">
                <div class="palette-name">Tea Rose Light</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #fff6f6"
                    onclick="selectColor('#FFF6F6', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ffeded"
                    onclick="selectColor('#FFEDED', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ffe3e3"
                    onclick="selectColor('#FFE3E3', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ffdada"
                    onclick="selectColor('#FFDADA', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ffd1d1"
                    onclick="selectColor('#FFD1D1', 'color3')"
                  ></div>
                </div>
              </div>
              <div class="palette-group">
                <div class="palette-name">Tea Rose Dark</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #ff7474"
                    onclick="selectColor('#FF7474', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ff1717"
                    onclick="selectColor('#FF1717', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ba0000"
                    onclick="selectColor('#BA0000', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #5d0000"
                    onclick="selectColor('#5D0000', 'color3')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #000"
                    onclick="selectColor('#000000', 'color3')"
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Light Red -->
          <div class="color-dropdown">
            <div
              class="main-color-swatch"
              id="color4"
              style="background-color: #ff7878"
              onclick="selectMainColor('#FF7878', 'color4')"
            ></div>
            <div class="dropdown-content" id="dropdown4">
              <div class="palette-group">
                <div class="palette-name">Light Red Light</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #ffe4e4"
                    onclick="selectColor('#FFE4E4', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ffcaca"
                    onclick="selectColor('#FFCACA', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ffafaf"
                    onclick="selectColor('#FFAFAF', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ff9595"
                    onclick="selectColor('#FF9595', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #ff7878"
                    onclick="selectColor('#FF7878', 'color4')"
                  ></div>
                </div>
              </div>
              <div class="palette-group">
                <div class="palette-name">Light Red Dark</div>
                <div class="palette-colors">
                  <div
                    class="palette-color"
                    style="background-color: #ff2f2f"
                    onclick="selectColor('#FF2F2F', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #e20000"
                    onclick="selectColor('#E20000', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #970000"
                    onclick="selectColor('#970000', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #4b0000"
                    onclick="selectColor('#4B0000', 'color4')"
                  ></div>
                  <div
                    class="palette-color"
                    style="background-color: #000"
                    onclick="selectColor('#000000', 'color4')"
                  ></div>
                </div>
              </div>
            </div>
          </div>

                     <!-- Jasmine -->
           <div class="color-dropdown">
             <div
               class="main-color-swatch"
               id="color5"
               style="background-color: #ffe978"
               onclick="selectMainColor('#FFE978', 'color5')"
             ></div>
             <div class="dropdown-content" id="dropdown5">
               <div class="palette-group">
                 <div class="palette-name">Jasmine Light</div>
                 <div class="palette-colors">
                   <div
                     class="palette-color"
                     style="background-color: #fffbe4"
                     onclick="selectColor('#FFFBE4', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #fff6ca"
                     onclick="selectColor('#FFF6CA', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #fff2af"
                     onclick="selectColor('#FFF2AF', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #ffed95"
                     onclick="selectColor('#FFED95', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #ffe978"
                     onclick="selectColor('#FFE978', 'color5')"
                   ></div>
                 </div>
               </div>
               <div class="palette-group">
                 <div class="palette-name">Jasmine Dark</div>
                 <div class="palette-colors">
                   <div
                     class="palette-color"
                     style="background-color: #ffdc2f"
                     onclick="selectColor('#FFDC2F', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #e2bd00"
                     onclick="selectColor('#E2BD00', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #977e00"
                     onclick="selectColor('#977E00', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #4b3f00"
                     onclick="selectColor('#4B3F00', 'color5')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #000"
                     onclick="selectColor('#000000', 'color5')"
                   ></div>
                 </div>
               </div>
             </div>
           </div>

           <!-- Wisteria -->
           <div class="color-dropdown">
             <div
               class="main-color-swatch"
               id="color6"
               style="background-color: #cf94ee"
               onclick="selectMainColor('#CF94EE', 'color6')"
             ></div>
             <div class="dropdown-content" id="dropdown6">
               <div class="palette-group">
                 <div class="palette-name">Wisteria Light</div>
                 <div class="palette-colors">
                   <div
                     class="palette-color"
                     style="background-color: #f5eafc"
                     onclick="selectColor('#F5EAFC', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #ecd5f8"
                     onclick="selectColor('#ECD5F8', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #e2bff5"
                     onclick="selectColor('#E2BFF5', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #d9aaf2"
                     onclick="selectColor('#D9AAF2', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #cf94ee"
                     onclick="selectColor('#CF94EE', 'color6')"
                   ></div>
                 </div>
               </div>
               <div class="palette-group">
                 <div class="palette-name">Wisteria Dark</div>
                 <div class="palette-colors">
                   <div
                     class="palette-color"
                     style="background-color: #b152e4"
                     onclick="selectColor('#B152E4', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #8e1fc9"
                     onclick="selectColor('#8E1FC9', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #5e1586"
                     onclick="selectColor('#5E1586', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #2f0a43"
                     onclick="selectColor('#2F0A43', 'color6')"
                   ></div>
                   <div
                     class="palette-color"
                     style="background-color: #000"
                     onclick="selectColor('#000000', 'color6')"
                   ></div>
                 </div>
               </div>
             </div>
           </div>
        </div>
                 <div class="color-labels">
           <span>Keppel</span>
           <span>Sky Blue</span>
           <span>Tea Rose</span>
           <span>Light Red</span>
           <span>Jasmine</span>
           <span>Wisteria</span>
         </div>
      </div>

      <div class="canvas-actions">
        <button class="clear-btn" onclick="clearCanvas()">üóëÔ∏è Clear</button>
        <button class="save-btn" onclick="saveCanvas()">üíæ Save</button>
        <button class="extract-btn" onclick="extractStrokes()">
          üîç Extract
        </button>
      </div>

      <div class="canvas-wrapper" id="canvasWrapper">
        <div id="p5-canvas"></div>
      </div>

      <div class="instructions">
        Try different brushes and see how they feel! Each one has its own
        personality.
      </div>
    </div>

    <script>
      let currentBrush = "marker";
      let hasDrawn = false;
      let currentColor = "#6BB9A4";
      let activeDropdown = null;
      let strokes = [];
      let currentStroke = [];
      //make a queue of strokes
      let strokeQueue = [];
      // Spray brush fix variables
      let sprayStartX = 0;
      let sprayStartY = 0;
      let hasSprayMoved = false;
      let minMovementDistance = 3;

      function selectMainColor(color, swatchId) {
        // Close any open dropdown first
        if (activeDropdown && activeDropdown !== swatchId) {
          document
            .getElementById("dropdown" + activeDropdown.slice(-1))
            .classList.remove("show");
        }

        currentColor = color;

        // Update selected state
        document.querySelectorAll(".main-color-swatch").forEach((swatch) => {
          swatch.classList.remove("selected");
        });
        document.getElementById(swatchId).classList.add("selected");

        // Toggle dropdown
        const dropdownId = "dropdown" + swatchId.slice(-1);
        const dropdown = document.getElementById(dropdownId);

        if (activeDropdown === swatchId) {
          dropdown.classList.remove("show");
          activeDropdown = null;
        } else {
          // Close other dropdowns
          document.querySelectorAll(".dropdown-content").forEach((dd) => {
            dd.classList.remove("show");
          });
          dropdown.classList.add("show");
          activeDropdown = swatchId;
        }
      }

      function selectColor(color, mainSwatchId) {
        currentColor = color;

        // Update main swatch color
        document.getElementById(mainSwatchId).style.backgroundColor = color;

        // Update selected state
        document.querySelectorAll(".main-color-swatch").forEach((swatch) => {
          swatch.classList.remove("selected");
        });
        document.getElementById(mainSwatchId).classList.add("selected");

        // Close dropdown
        const dropdownId = "dropdown" + mainSwatchId.slice(-1);
        document.getElementById(dropdownId).classList.remove("show");
        activeDropdown = null;
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".color-dropdown")) {
          document.querySelectorAll(".dropdown-content").forEach((dropdown) => {
            dropdown.classList.remove("show");
          });
          activeDropdown = null;
        }
      });

      function setBrush(brushType) {
        currentBrush = brushType;

        // Update active button
        document.querySelectorAll(".brush-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`.brush-btn.${brushType}`)
          .classList.add("active");
      }

      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }

      function clearCanvas() {

        hasDrawn = false;
        document.getElementById("canvasWrapper").classList.remove("drawing");
        clear();
        background("#fbf8f3");
        //clear the strokes
        strokes = [];
        currentStroke = [];
      }

      function saveCanvas() {
        const now = new Date();
        const timestamp =
          now.getFullYear() +
          String(now.getMonth() + 1).padStart(2, "0") +
          String(now.getDate()).padStart(2, "0") +
          "_" +
          String(now.getHours()).padStart(2, "0") +
          String(now.getMinutes()).padStart(2, "0") +
          String(now.getSeconds()).padStart(2, "0");

        const filename = `drawing_${timestamp}`;
        save(filename + ".png");
      }

      function extractStrokes() {
        console.log("Extracting strokes...", strokes);
        // Convert strokes to the expected format
        let processedStrokes = [];

        for (let stroke of strokes) {
          if (stroke.points && stroke.points.length > 0) {
            // Extract x and y coordinates from points
            let xCoords = stroke.points.map((point) => point.x);
            let yCoords = stroke.points.map((point) => point.y);

            processedStrokes.push({
              brush: stroke.brush,
              color: stroke.color,
              stroke: {
                x: xCoords,
                y: yCoords,
              },
            });
          }
        }

        const strokeData = {
          strokes: processedStrokes,
          metadata: {
            totalStrokes: processedStrokes.length,
            canvasSize: { width: width, height: height },
            timestamp: new Date().toISOString(),
          },
        };

        saveJSON(strokeData, "strokes.json");
        console.log("Strokes saved:", strokeData);
      }

      function setup() {
        let canvas = createCanvas(850, 500);
        canvas.parent("p5-canvas");
        background("#fbf8f3");
        strokeCap(ROUND);

        // Set initial brush to marker
        setBrush("marker");
      }

      function mousePressed() {
        // Start a new stroke when mouse is pressed
        if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
          currentStroke = [];
          currentStroke.push({
            x: mouseX,
            y: mouseY,
            color: currentColor,
            brush: currentBrush,
          });
          strokeQueue.push({
            x: mouseX,
            y: mouseY,
            color: currentColor,
            brush: currentBrush
          });
          // Reset spray tracking when mouse is pressed
          if (currentBrush === "spray") {
            sprayStartX = mouseX;
            sprayStartY = mouseY;
            hasSprayMoved = false;
          }

          if (!hasDrawn) {
            hasDrawn = true;
            document.getElementById("canvasWrapper").classList.add("drawing");
          }
        }
      }

      function mouseDragged() {
            // Continue the current stroke when mouse is dragged
            if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                console.log('Mouse dragged but drawing is disabled');
                currentStroke.push({
                    x: mouseX,
                    y: mouseY,
                    color: currentColor,
                    brush: currentBrush
                });
                strokeQueue.push({
                    x: mouseX,
                    y: mouseY,
                    color: currentColor,
                    brush: currentBrush
                })
                // Draw based on current brush
                // switch(currentBrush) {
                //     case 'marker':
                //         marker();
                //         break;
                //     case 'crayon':
                //         crayon();
                //         break;
                //     case 'wiggle':
                //         wiggle();
                //         break;
                //     case 'spray':
                //         spray();
                //         break;
                //     case 'fountain':
                //         fountain();
                //         break;
                // }
                // execute a stroke from the queue if exists
                if (strokeQueue.length > 1) {
                    executeStroke();
                }
            }
        }

      function mouseReleased() {
          // Finalize the stroke when mouse is released
          if (currentStroke.length > 0) {
              strokes.push({
                  brush: currentBrush,
                  color: currentColor,
                  points: currentStroke
              });
              console.log('Stroke completed:', strokes[strokes.length - 1]);
          }
          if (strokeQueue.length > 1) executeStroke();
          currentStroke = [];
          strokeQueue = [];
      }
      function executeStroke() {
          // Need at least 2 points to draw a stroke
          if (strokeQueue.length < 2) {
              return;
          }

          // Get start and end points from front of queue
          const startPoint = strokeQueue.shift(); // Remove and get first point
          const endPoint = strokeQueue[0]; // Get second point (now first)

          // Get brush parameters
          const best_params = {
              "fountain": [28,70],
              "marker": [8,20],
              "spray": [20,50],
              "wiggle": [8,20],
              "crayon": [8,20]
          };
          const step_length = best_params[startPoint.brush][0];
          const step_duration = best_params[startPoint.brush][1];

          // Calculate distance between points
          const distance = Math.sqrt(
              Math.pow(endPoint.x - startPoint.x, 2) +
              Math.pow(endPoint.y - startPoint.y, 2)
          );

          // Calculate steps needed
          const steps_per_segment = Math.max(1, Math.floor(distance / step_length));

          // Execute continuous stroke with interpolation
          for (let s = 0; s <= steps_per_segment; s++) {
              const t = s / steps_per_segment;
              const interpX = lerp(startPoint.x, endPoint.x, t);
              const interpY = lerp(startPoint.y, endPoint.y, t);
              pmouseX = (s === 0) ? startPoint.x : mouseX;
              pmouseY = (s === 0) ? startPoint.y : mouseY;
              mouseX = interpX;
              mouseY = interpY;

              // Call brush function if there is movement
              if ((mouseX !== pmouseX) || (mouseY !== pmouseY)) {
                  switch(startPoint.brush) {
                      case 'marker':
                          marker();
                          break;
                      case 'crayon':
                          crayon();
                          break;
                      case 'wiggle':
                          wiggle();
                          break;
                      case 'spray':
                          spray();
                          break;
                      case 'fountain':
                          fountain();
                          break;
                  }
              }
          }
      }
      function draw() {
        // The draw function is now mainly for continuous drawing effects if needed
        // Most drawing logic has been moved to mouseDragged()
      }

      function marker() {
        const color = hexToRgb(currentColor);
        fill(color.r, color.g, color.b, 40);
        noStroke();
        circle(mouseX, mouseY, 50);
      }

      function crayon() {
        const color = hexToRgb(currentColor);
        const baseColor = [color.r, color.g, color.b];

        fill(baseColor[0], baseColor[1], baseColor[2], 200);
        noStroke();

        const distance = dist(mouseX, mouseY, pmouseX, pmouseY);
        const steps = Math.max(1, Math.floor(distance / 3));

        for (let i = 0; i <= steps; i++) {
          const x = lerp(pmouseX, mouseX, i / steps);
          const y = lerp(pmouseY, mouseY, i / steps);

          circle(x, y, 12);

          for (let j = 0; j < 8; j++) {
            const textureX = x + random(-10, 10);
            const textureY = y + random(-10, 10);
            fill(baseColor[0], baseColor[1], baseColor[2], 100);
            circle(textureX, textureY, 6);
          }

          for (let k = 0; k < 4; k++) {
            const textureX2 = x + random(-15, 15);
            const textureY2 = y + random(-15, 15);
            fill(baseColor[0], baseColor[1], baseColor[2], 50);
            circle(textureX2, textureY2, 3);
          }
        }
      }

      let wiggle_flip = 0;
      function wiggle() {
        const color = hexToRgb(currentColor);
        stroke(color.r, color.g, color.b, 255);
        strokeWeight(3);
        noFill();

        const distance = dist(mouseX, mouseY, pmouseX, pmouseY);
        const midX = (mouseX + pmouseX) / 2;
        const midY = (mouseY + pmouseY) / 2;

        const angle = Math.atan2(mouseY - pmouseY, mouseX - pmouseX);
        const flip = wiggle_flip * PI;
        wiggle_flip = 1 - wiggle_flip;

        arc(midX, midY, distance, distance, angle + flip, angle + PI + flip);
      }

      function spray() {
        // Check if mouse has moved enough to start spraying
        if (!hasSprayMoved) {
          let distance = dist(mouseX, mouseY, sprayStartX, sprayStartY);
          if (distance < minMovementDistance) {
            return; // Don't spray until mouse has moved enough
          }
          hasSprayMoved = true;
        }

        // Only spray when mouse is moving, not when held stationary
        if (mouseX === pmouseX && mouseY === pmouseY) {
          return;
        }

        // Spray is always black
        stroke(0, 0, 0, 255);
        strokeWeight(1);

        const speed = abs(mouseX - pmouseX) + abs(mouseY - pmouseY);
        const minRadius = 8;
        const sprayDensity = Math.min(20, Math.max(5, speed * 2)); // Density based on movement speed
        const r = speed + minRadius;
        const rSquared = r * r;

        // Only spray along the movement path, not repeatedly at same position
        const distance = dist(mouseX, mouseY, pmouseX, pmouseY);
        const lerps = Math.max(1, Math.floor(distance / 3)); // Fewer interpolation points

        for (let i = 0; i < lerps; i++) {
          const lerpX = lerp(pmouseX, mouseX, i / lerps);
          const lerpY = lerp(pmouseY, mouseY, i / lerps);

          for (let j = 0; j < sprayDensity; j++) {
            const randX = random(-r, r);
            const randY = random(-1, 1) * sqrt(rSquared - randX * randX);
            point(lerpX + randX, lerpY + randY);
          }
        }
      }

      function fountain() {
        // Fountain is always black
        stroke(0, 0, 0, 255);
        strokeWeight(1);
        const width = 4;
        const lerps = 12;

        for (let i = 0; i < lerps; i++) {
          const x = lerp(mouseX, pmouseX, i / lerps);
          const y = lerp(mouseY, pmouseY, i / lerps);
          line(x - width, y - width, x + width, y + width);
        }
      }

      function windowResized() {
        const container = document.querySelector(".canvas-wrapper");
        const containerWidth = container.offsetWidth - 50;
        const containerHeight = Math.min(500, window.innerHeight * 0.6);

        resizeCanvas(Math.min(850, containerWidth), containerHeight);
        background("#fbf8f3");
      }
    </script>
  </body>
</html>
